#!/usr/bin/env perl

# ===================================================================
# File:     remove-pages-demo-data.pl
# Purpose:  Remove pages demo data in reverse order with ANSI colors
#
# Author:	Kai Baker <eigenspaces@gmail.com>
#
# ShinyCMS is free software; you can redistribute it and/or modify it
# under the terms of either the GPL 2.0 or the Artistic License 2.0
# ===================================================================

use strict;
use warnings;
use Term::ANSIColor;
use English;

# ANSI color codes for better readability
my $GREEN  = color('green');
my $YELLOW = color('yellow');
my $RED    = color('red');
my $CYAN   = color('cyan');
my $MAGENTA = color('magenta');
my $BLUE   = color('blue');
my $RESET  = color('reset');

# Load local helper lib and get connected schema object
use FindBin qw( $Bin );
use lib "$Bin/../../lib";

eval {
    # Check if we can load the helper module
    require 'helpers.pl';
};

if ($EVAL_ERROR) {
    print "${RED}[ERROR]${RESET} Cannot load helpers.pl: $EVAL_ERROR\n";
    print "${YELLOW}[INFO]${RESET} Make sure helpers.pl is in the lib directory\n";
    exit 1;
}

print "${MAGENTA}===========================================${RESET}\n";
print "${MAGENTA}      Pages Data Removal Script             ${RESET}\n";
print "${MAGENTA}===========================================${RESET}\n\n";

# Get schema connection
my $schema;
eval {
    $schema = get_schema();
};
if ($EVAL_ERROR) {
    print "${RED}[ERROR]${RESET} Failed to get database schema: $EVAL_ERROR\n";
    exit 1;
}

print "${GREEN}[OK]${RESET} Database connection established\n\n";

# Track removal statistics
my $total_removed = 0;
my %removal_stats = (
    cms_forms           => 0,
    cms_page_elem       => 0,
    cms_page            => 0,
    cms_section         => 0,
    cms_template_elem   => 0,
    cms_template        => 0,
);
my @page_items_removed;

# deletion order: CmsForm->CmsPageElement->CmsPage->CmsSection->CmsTemplateElement->CmsTemplate

# ============================================
# STEP 1: Remove CmsForms
# ============================================
print "${CYAN}[STEP 1/6]${RESET} Removing CmsForms...\n";

eval {
    my @form_names = ('Contact Form', 'Contact Form (sends HTML email)');
    foreach my $name (@form_names) {
        my $form = $schema->resultset('CmsForm')->find({ name => $name });
        if ($form) {
            my $form_id = $form->id;
            $form->delete;
            $removal_stats{cms_forms}++;
            print "${GREEN}  ✓${RESET} Removed form ID: ${YELLOW}$form_id${RESET}\n";
        }
    }
};

if ($EVAL_ERROR) {
    print "${RED}  ✗${RESET} Error removing CmsForms: $EVAL_ERROR\n";
}

if ($removal_stats{cms_forms} == 0) {
    print "${YELLOW}  ⚠${RESET} No CmsForms found to remove\n";
}

# ============================================
# STEP 1.1: Clear default_page from CmsSections
# ============================================
print "${CYAN}[STEP 2.5/6]${RESET} Clearing default_page references from CmsSections...\n";

eval {
    my @cms_sections = ('Home', 'More');
    foreach my $name (@cms_sections) {
        my $section = $schema->resultset('CmsSection')->find({ name => $name });
        if ($section && $section->default_page) {
            $section->update({ default_page => undef });
            print "${GREEN}  ✓${RESET} Cleared default_page from section: ${YELLOW}$name${RESET}\n";
        }
    }
};

if ($EVAL_ERROR) {
    print "${RED}  ✗${RESET} Error clearing default_page references: $EVAL_ERROR\n";
}

# ============================================
# STEP 1.2: Clear default_page from CmsPage
# ============================================
print "${CYAN}[STEP 1.2/6]${RESET} Clearing default_page references from CmsPage...\n";

eval {
    my @cms_page = ('Home', 'About ShinyCMS', 'Feature List', 'Contact Us');
    foreach my $name (@cms_page) {
        my $page = $schema->resultset('CmsPage')->find({ name => $name });
        if ($page && $page->default_page) {
            $page->update({ default_page => undef });
            print "${GREEN}  ✓${RESET} Cleared default_page from page: ${YELLOW}$name${RESET}\n";
        }
    }
};

if ($EVAL_ERROR) {
    print "${RED}  ✗${RESET} Error clearing default_page references: $EVAL_ERROR\n";
}

# ============================================
# STEP 1.3: Clear default_page from CmsPageElement
# ============================================
print "${CYAN}[STEP 1.2/6]${RESET} Clearing default_page references from CmsPageElement...\n";

eval {
    my @cms_page_element = ('Home', 'About ShinyCMS', 'Feature List', 'Contact Us');
    foreach my $name (@cms_page_element) {
        my $page_element = $schema->resultset('CmsPageElement')->find({ name => $name });
        if ($page_element && $page_element->default_page) {
            $page_element->update({ default_page => undef });
            print "${GREEN}  ✓${RESET} Cleared default_page from page element: ${YELLOW}$name${RESET}\n";
        }
    }
};

if ($EVAL_ERROR) {
    print "${RED}  ✗${RESET} Error clearing default_page references: $EVAL_ERROR\n";
}

# ============================================
# STEP 2: Remove CmsPageElement
# ============================================
print "${CYAN}[STEP 2/6]${RESET} Removing CmsPageElement...\n";

# Step 1: Delete CmsPageElements
my @page_names = ('Home', 'About ShinyCMS', 'Feature List', 'Contact Us');
eval {
    foreach my $name (@page_names) {
        my $page = $schema->resultset('CmsPage')->find({ name => $name });
        if ($page) {
            my @elements = $page->cms_page_elements->all;
            foreach my $element (@elements) {
                my $element_id = $element->id;
                $element->delete;
                $removal_stats{cms_page_elem}++;
                print "${GREEN}  ✓${RESET} Removed page element ID: ${YELLOW}$element_id${RESET}\n";
            }
        }
    }
};

if ($EVAL_ERROR) {
    print "${RED}  ✗${RESET} Error removing CmsPageElements: $EVAL_ERROR\n";
}

if ($removal_stats{cms_page_elem} == 0) {
    print "${YELLOW}  ⚠${RESET} No CmsPageElements found to remove\n";
}

# ============================================
# STEP 3: Remove CmsPages
# ============================================
print "${CYAN}[STEP 3/6]${RESET} Removing CmsPages...\n";

eval {
    foreach my $name (@page_names) {
        my $page = $schema->resultset('CmsPage')->find({ name => $name });
        if ($page) {
            my $page_id = $page->id;
            push @page_items_removed, { title => $page->title, id => $page_id };
            $page->delete;
            $removal_stats{cms_page}++;
            print "${GREEN}  ✓${RESET} Removed page ID: ${YELLOW}$page_id${RESET}\n";
        }
    }
};

if ($EVAL_ERROR) {
    print "${RED}  ✗${RESET} Error removing CmsPages: $EVAL_ERROR\n";
}

if ($removal_stats{cms_page} == 0) {
    print "${YELLOW}  ⚠${RESET} No CmsPages found to remove\n";
}

# ============================================
# STEP 4: Remove CmsSection
# ============================================
print "${CYAN}[STEP 4/6]${RESET} Removing CmsSection...\n";

eval {
    my @cms_sections = ('Home', 'More');
    foreach my $name (@cms_sections) {
        my $section = $schema->resultset('CmsSection')->find({ name => $name });
        if ($section) {
            my $section_id = $section->id;
            $section->delete;
            $removal_stats{cms_section}++;
            print "${GREEN}  ✓${RESET} Removed section ID: ${YELLOW}$section_id${RESET}\n";
        }
    }
};

if ($EVAL_ERROR) {
    print "${RED}  ✗${RESET} Error removing CmsSections: $EVAL_ERROR\n";
}

if ($removal_stats{cms_section} == 0) {
    print "${YELLOW}  ⚠${RESET} No CmsSections found to remove\n";
}
# KBAKER 20251107: delete CmsTemplateElement and record deletion statistics
# ============================================
# STEP 5: Remove CmsTemplateElement
# ============================================
print "${CYAN}[STEP 5/6]${RESET} Removing CmsTemplateElements...\n";

my @template_names = ('Homepage', 'Subpage 1', 'Contact Form');
eval {
    foreach my $name (@template_names) {
        my $templates = $schema->resultset('CmsTemplate')->find({ name => $name });
        if ($templates) {
            my @elements = $templates->cms_template_elements->all;
            foreach my $element (@elements) {
                my $element_id = $element->id;
                $element->delete;
                $removal_stats{cms_template_elem}++;
                print "${GREEN}  ✓${RESET} Removed template element ID: ${YELLOW}$element_id${RESET}\n";
            }
        }
    }
};

if ($EVAL_ERROR) {
    print "${RED}  ✗${RESET} Error removing CmsTemplateElements: $EVAL_ERROR\n";
}

if ($removal_stats{cms_template_elem} == 0) {
    print "${YELLOW}  ⚠${RESET} No CmsTemplateElements found to remove\n";
}

# KBAKER 20251107: delete CmsTemplate and record deletion statistics
# ============================================
# STEP 6: Remove CmsTemplates
# ============================================
print "${CYAN}[STEP 6/6]${RESET} Removing CmsTemplates...\n";

eval {
    foreach my $name (@template_names) {
        my $template = $schema->resultset('CmsTemplate')->find({ name => $name });
        if ($template) {
            my $template_id = $template->id;
            $template->delete;
            $removal_stats{cms_template}++;
            print "${GREEN}  ✓${RESET} Removed template ID: ${YELLOW}$template_id${RESET}\n";
        }
    }
};

if ($EVAL_ERROR) {
    print "${RED}  ✗${RESET} Error removing CmsTemplates: $EVAL_ERROR\n";
}

if ($removal_stats{cms_template} == 0) {
    print "${YELLOW}  ⚠${RESET} No CmsTemplates found to remove\n";
}

# KBAKER 20251107: deletion and statistics summary
# ============================================
# Summary
# ============================================
print "\n${MAGENTA}===========================================${RESET}\n";
print "${MAGENTA}            REMOVAL SUMMARY                ${RESET}\n";
print "${MAGENTA}===========================================${RESET}\n\n";

$total_removed = 0;
foreach my $key (keys %removal_stats) {
    $total_removed += $removal_stats{$key};
}

if ($total_removed > 0) {
    print "${GREEN}[SUCCESS]${RESET} Removal operation completed\n\n";
    
    print "${BLUE}Removal Statistics:${RESET}\n";
    print "  CmsForms:              ${YELLOW}" . sprintf("%3d", $removal_stats{cms_forms}) . "${RESET}\n";
    print "  CmsPageElements:       ${YELLOW}" . sprintf("%3d", $removal_stats{cms_page_elem}) . "${RESET}\n";
    print "  CmsPages:              ${YELLOW}" . sprintf("%3d", $removal_stats{cms_page}) . "${RESET}\n";
    print "  CmsSections:           ${YELLOW}" . sprintf("%3d", $removal_stats{cms_section}) . "${RESET}\n";
    print "  CmsTemplateElements:   ${YELLOW}" . sprintf("%3d", $removal_stats{cms_template_elem}) . "${RESET}\n";
    print "  CmsTemplates:          ${YELLOW}" . sprintf("%3d", $removal_stats{cms_template}) . "${RESET}\n";
    print "  ${CYAN}─────────────────${RESET}\n";
    print "  Total:        ${GREEN}" . sprintf("%3d", $total_removed) . "${RESET}\n";
    
    if (@page_items_removed) {
        print "\n${BLUE}Pages Items Removed:${RESET}\n";
        foreach my $item (@page_items_removed) {
            print "  - ${CYAN}" . $item->{title} . "${RESET} (ID: " . $item->{id} . ")\n";
        }
    }
} else {
    print "${YELLOW}[WARNING]${RESET} No data was removed\n";
    print "${YELLOW}[INFO]${RESET} The page demo data may have already been removed\n";
}

print "\n${GREEN}[COMPLETE]${RESET} Page data removal finished\n";