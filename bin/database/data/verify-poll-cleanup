#!/usr/bin/env perl

# ===================================================================
# File:     verify-poll-cleanup.pl
# Purpose:  Verify no orphaned poll-related data remains
#
# Author:	Kai Baker <eigenspaces@gmail.com>
#
# ShinyCMS is free software; you can redistribute it and/or modify it
# under the terms of either the GPL 2.0 or the Artistic License 2.0
# ===================================================================

use strict;
use warnings;
use Term::ANSIColor;
use English;

# ANSI color codes for better readability
my $GREEN  = color('green');
my $YELLOW = color('yellow');
my $RED    = color('red');
my $CYAN   = color('cyan');
my $MAGENTA = color('magenta');
my $BLUE   = color('blue');
my $BOLD   = color('bold');
my $RESET  = color('reset');

# Load local helper lib and get connected schema object
use FindBin qw( $Bin );
use lib "$Bin/../../lib";

# KBAKER 20251031: add eval block around require statement to capture errors
eval {
    # Check if we can load the helper module
    require 'helpers.pl';
};

if ($EVAL_ERROR) {
    print "${RED}[ERROR]${RESET} Cannot load helpers.pl: $EVAL_ERROR\n";
    print "${YELLOW}[INFO]${RESET} Make sure helpers.pl is in the lib directory\n";
    exit 1;
}

print "${BLUE}===========================================${RESET}\n";
print "${BLUE}    Poll Data Verification Script          ${RESET}\n";
print "${BLUE}===========================================${RESET}\n\n";

# Get schema connection
my $schema;
eval {
    $schema = get_schema();
};
if ($EVAL_ERROR) {
    print "${RED}[ERROR]${RESET} Failed to get database schema: $EVAL_ERROR\n";
    exit 1;
}

print "${GREEN}[OK]${RESET} Database connection established\n\n";
# Track orphaned data
# KBAKER 20251031: add next four statistical collection variables
my $orphaned_answers_found = 0;
my $orphaned_questions_found = 0;
my $total_checks = 0;
my $items_remaining = 0;
my @orphan_reports;
my %verification_stats;

# ============================================
# 1. Check polls answers
# ============================================

print "${CYAN}[1/2] Checking for demo answers...${RESET}\n";

# KBAKER 20251031: rename @demo_answers to more descriptive @poll_answers
my @poll_answers;
eval {
    @poll_answers = $schema->resultset('PollAnswer')->all;
    $verification_stats{answers} = scalar(@poll_answers);
};

if($EVAL_ERROR) {
     print "${RED}  ✗${RESET} Error checking poll items: $EVAL_ERROR\n";
} elsif(@poll_answers) {
    print "${RED}  ✗${RESET} Found " . scalar(@poll_answers) . " poll item(s) still in database:\n";

    my $demo_items = 0;
    foreach my $item (@poll_answers) {
        $demo_items++;
        # KBAKER 20251031: add statistical collection variable
        $items_remaining++;
        print "    - ${CYAN}" . substr($item->answer, 0, 50) . 
        # KBAKER 20251031: bug fix, change $item->title to $item->answer
              (length($item->answer) > 50 ? "..." : "") . "${RESET}\n";
        print "      ID: ${YELLOW}" . $item->id . "${RESET}";
        print "\n";
    }

    if($demo_items > 0) {
        push @orphan_reports, "$demo_items demo poll item(s) found";
    }
    # KBAKER 20251031: add statistical collection variable
    $orphaned_answers_found++;
} else {
    print "${GREEN}  ✓${RESET} No poll items found (clean)\n";
}
# KBAKER 20251031: add statistical collection variable
$total_checks += $orphaned_answers_found;

# ============================================
# 4. Check for Orphaned Questions
# ============================================
print "\n${CYAN}[2/2] Checking for orphaned questions...${RESET}\n";

my @poll_questions;
# KBAKER 20251031: bug fix, remove 'my' before '@poll_questions' and add semicolon to end of eval block
eval {
    @poll_questions = $schema->resultset('PollQuestion')->all;
    $verification_stats{questions} = scalar(@poll_questions);
};

if(@poll_questions) {
    print "${YELLOW}  ⚠${RESET} Found " . scalar(@poll_questions) . " Poll question(s):\n";

    my $demo_items = 0;
    foreach my $item (@poll_questions) {
        $demo_items++;
        # KBAKER 20251031: add statistical collection variable
        $items_remaining++;
        print "    - ${CYAN}" . substr($item->question, 0, 50) . 
        # KBAKER 20251031: bug fix, change $item->title to $item->question
            (length($item->question) > 50 ? "..." : "") . "${RESET}\n";
        print "      ID: ${YELLOW}" . $item->id . "${RESET}";
        print "\n";
    }

    if($demo_items > 0) {
        push @orphan_reports, "$demo_items demo poll item(s) found";
    }
    # KBAKER 20251031: add statistical collection variable
    $orphaned_questions_found++;
} else {
    print "${GREEN}  ✓${RESET} No poll items found (clean)\n";
}

# KBAKER 20251031: add statistical summary

$total_checks += $orphaned_questions_found;

print "\n";

# Summary Section
print "${BOLD}${CYAN}=" x 70 . "${RESET}\n";
print "${BOLD}VERIFICATION SUMMARY${RESET}\n";
print "${CYAN}" . "-" x 70 . "${RESET}\n";

print "Total items checked: ${BOLD}$total_checks${RESET}\n";
print "Items still in database: ${RED}${BOLD}$items_remaining${RESET}\n";

if ($orphaned_questions_found > 0 || $orphaned_answers_found > 0) {
    my $orphaned_total = $orphaned_questions_found + $orphaned_answers_found;
    print "Orphaned items found: ${YELLOW}${BOLD}$orphaned_total${RESET}\n";
}

print "\n";

# Final Status
if ($items_remaining == 0 && $orphaned_questions_found == 0 && $orphaned_answers_found == 0) {
    print "${GREEN}${BOLD}✓ SUCCESS: All poll demo data has been successfully removed!${RESET}\n";
    print "${GREEN}The database is clean.${RESET}\n";
} elsif ($items_remaining > 0) {
    print "${RED}${BOLD}✗ FAILURE: Poll demo data still exists in the database!${RESET}\n";
    print "${RED}Please run the cleanup script to remove remaining items.${RESET}\n";
} else {
    print "${YELLOW}${BOLD}⚠ WARNING: Main data removed but orphaned items remain!${RESET}\n";
    print "${YELLOW}Consider running a deep cleanup to remove orphaned records.${RESET}\n";
}

print "${CYAN}=" x 70 . "${RESET}\n";

# Exit with appropriate code
# 0 = all clean, 1 = main items remain, 2 = only orphaned items remain
if ($items_remaining == 0 && $orphaned_questions_found == 0 && $orphaned_answers_found == 0) {
    exit 0;
} elsif ($items_remaining > 0) {
    exit 1;
} else {
    exit 2;
}